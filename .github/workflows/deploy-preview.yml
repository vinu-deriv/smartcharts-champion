# Preview deployment workflow
# Builds SmartCharts-champion and integrates with derivatives-trader for preview

name: Deploy Preview

on:
    pull_request:
        branches:
            - '**'
        types: [opened, synchronize, reopened]
    workflow_dispatch:
        inputs:
            smartcharts_ref:
                description: 'smartcharts-champion branch/tag/SHA to build'
                required: true
                default: 'master'
            flutter_chart_ref:
                description: 'flutter-chart branch/tag/SHA to use in chart_app'
                required: true
                default: 'master'

# Cancel outdated deployments per PR
concurrency:
    group: deploy-preview-${{ github.event.number || github.run_id }}
    cancel-in-progress: true

jobs:
    build_and_deploy_preview_link:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            checks: write
            pull-requests: write
        steps:
            - name: Verify user
              if: github.event_name == 'pull_request'
              uses: 'deriv-com/shared-actions/.github/actions/verify_user_in_organization@v3'
              with:
                  username: ${{ github.event.pull_request.user.login }}
                  token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            - name: Post preview build comment
              if: github.event_name == 'pull_request'
              id: post_preview_build_comment
              uses: 'deriv-com/shared-actions/.github/actions/post_preview_build_comment@v1'
              with:
                  issue_number: ${{ github.event.number }}
                  head_sha: ${{ github.event.pull_request.head.sha }}

            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  repository: deriv-com/smartcharts-champion
                  path: smartcharts-champion
                  ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.smartcharts_ref || github.event.pull_request.head.sha }}
                  persist-credentials: false

            - name: Checkout derivatives-trader
              uses: actions/checkout@v4
              with:
                  repository: deriv-com/derivatives-trader
                  path: derivatives-trader
                  ref: master
                  token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
                  persist-credentials: false

            - name: Setup Flutter
              uses: subosito/flutter-action@62f096cacda5168a3bd7b95793373be14fa4fbaf
              with:
                  flutter-version: '3.24.1'
                  channel: 'stable'
                  cache: true

            - name: Update flutter-chart ref in pubspec.yaml
              if: github.event_name == 'workflow_dispatch'
              run: |
                  cd smartcharts-champion/chart_app
                  sed -i 's/ref: master/ref: ${{ github.event.inputs.flutter_chart_ref }}/' pubspec.yaml
                  echo "Updated pubspec.yaml to use flutter-chart ref: ${{ github.event.inputs.flutter_chart_ref }}"
                  cat pubspec.yaml

            - name: Build Flutter chart component
              run: |
                  cd smartcharts-champion/chart_app
                  flutter pub get
                  flutter build web --web-renderer html --release

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 22.x

            - name: Setup derivatives-trader
              run: cd derivatives-trader && npm run bootstrap

            - name: Remove existing @deriv-com/smartcharts-champion in derivatives-trader
              run: rm -rf derivatives-trader/node_modules/@deriv-com/smartcharts-champion/dist

            - name: Setup SmartCharts
              run: cd smartcharts-champion && npm install

            - name: Build SmartCharts
              run: cd smartcharts-champion && npm run build -- --output-path ../derivatives-trader/node_modules/@deriv-com/smartcharts-champion/dist

            - name: Build derivatives-trader
              env:
                  NODE_ENV: 'staging'
              run: cd derivatives-trader && npm run build:all

            - name: Setup Node for Cloudflare
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Publish to CF pages branch
              id: publish_to_pages_branch
              uses: 'deriv-com/shared-actions/.github/actions/publish_to_pages_branch@v1'
              with:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_TEST_LINKS_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_TEST_LINKS_ACCOUNT_ID }}
                  project_name: 'derivatives-trader'
                  branch_name: ${{ github.head_ref || github.event.inputs.smartcharts_ref }}
                  output_dir: derivatives-trader/packages/core/dist

            - name: Generate preview link comment
              if: always() && github.event_name == 'pull_request' && steps.post_preview_build_comment.outcome == 'success'
              uses: 'deriv-com/shared-actions/.github/actions/post_preview_link_comment@v1'
              with:
                  issue_number: ${{ github.event.number }}
                  check_run_id: ${{ steps.post_preview_build_comment.outputs.check_run_id }}
                  preview_url: ${{ steps.publish_to_pages_branch.outputs.cf_pages_url }}
                  status: ${{ job.status }}

            - name: Output preview URL for manual trigger
              if: github.event_name == 'workflow_dispatch'
              run: |
                  echo "## Preview Deployment Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Preview URL:** ${{ steps.publish_to_pages_branch.outputs.cf_pages_url }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
                  echo "- smartcharts-champion ref: \`${{ github.event.inputs.smartcharts_ref }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- flutter-chart ref: \`${{ github.event.inputs.flutter_chart_ref }}\`" >> $GITHUB_STEP_SUMMARY